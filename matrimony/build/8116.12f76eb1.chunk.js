"use strict";(self.webpackChunkmatrimony=self.webpackChunkmatrimony||[]).push([[8116],{8116:(hs,$,s)=>{s.d($,{ReviewWorkflowsEditPage:()=>is});var t=s(92132),l=s(21272),G=s(85963),C=s(83997),J=s(43064),L=s(85829),M=s(89167),b=s(54514),R=s(61535),q=s(54894),r=s(82437),ss=s(17703),ts=s(39235),os=s(87281),e=s(82797),es=s(21587),S=s(60636),ns=s(65143),h=s(12472),E=s(45084),W=s(25524),as=s(74013),cs=s(35658),As=s(56336),Cs=s(48940),Ls=s(12083),Rs=s(55151),Ws=s(79077),Ts=s(2600),Is=s(51187),Bs=s(15126),Ks=s(63299),Us=s(67014),us=s(59080),ys=s(79275),ws=s(14718),js=s(5790),Ss=s(35223),ps=s(5409),xs=s(74930),Fs=s(41286),ks=s(13426),Ns=s(84624),Vs=s(77965),Ys=s(54257),zs=s(71210),Hs=s(39404),Zs=s(58692),Qs=s(501),Xs=s(57646),$s=s(23120),Gs=s(44414),Js=s(25962),bs=s(14664),qs=s(42588),st=s(90325),tt=s(62785),ot=s(87443),et=s(41032),nt=s(22957),at=s(93179),it=s(73055),rt=s(15747),lt=s(85306),_t=s(26509),Et=s(32058),dt=s(81185),Mt=s(82261);const is=()=>{const{workflowId:T}=(0,ss.g)(),rs=(0,r.d4)(es.s),{formatMessage:n}=(0,q.A)(),_=(0,r.wA)(),{_unstableFormatAPIError:ls,_unstableFormatValidationErrors:_s}=(0,M.useAPIErrorHandler)(),D=(0,M.useNotification)(),{isLoading:P,meta:O,workflows:g}=(0,as.u)(),{collectionTypes:p,singleTypes:x,isLoading:I}=(0,os.u)(),Es=(0,r.d4)(e.j),ds=(0,r.d4)(e.a),a=(0,r.d4)(e.b),F=(0,r.d4)(e.k),k=(0,r.d4)(e.c),m=(0,r.d4)(e.s),{allowedActions:{canDelete:Ms,canUpdate:B}}=(0,M.useRBAC)(rs.settings?.["review-workflows"]),[c,A]=l.useState({}),{getFeature:Ds,isLoading:N}=(0,S.m)(),{isLoading:K,roles:V}=(0,ts.u)(void 0),[Y,d]=l.useState(null),[Ps,z]=l.useState(),[Os,H]=l.useState(!1),U=g?.find(o=>o.id===parseInt(T,10)),Z=g?.filter(o=>o.id!==parseInt(T,10)).flatMap(o=>o.contentTypes),u=Ds("review-workflows"),v=u?.[W.C],f=u?.[W.a],[gs]=(0,ns.e)(),Q=async()=>{z(void 0),H(!0);try{const o=await gs({id:T,data:{...a,stages:a.stages?.map(i=>{let X=!0;const w=Es.workflow?.stages?.find(j=>j.id===i?.id);return w&&(X=w.permissions?.length!==i.permissions?.length||!w.permissions?.every(j=>!!i.permissions?.find(fs=>fs.role===j.role))),{...i,permissions:X?i.permissions:void 0}})}});if("error"in o){(0,S.x)(o.error)&&o.error.name==="ValidationError"&&z(_s(o.error)),D({type:"warning",message:ls(o.error)});return}D({type:"success",message:{id:"notification.success.saved",defaultMessage:"Saved"}})}catch{D({type:"warning",message:{id:"notification.error",defaultMessage:"An error occurred"}})}finally{H(!1)}A({})},ms=async()=>{await Q()},vs=()=>{A({})},y=(0,R.useFormik)({enableReinitialize:!0,initialErrors:Ps,initialValues:a,async onSubmit(){const o=a.contentTypes?.some(i=>Z?.includes(i));O&&v&&O?.workflowCount>parseInt(v,10)?d("workflow"):a.stages&&f&&a.stages.length>parseInt(f,10)?d("stage"):F||o?(F&&A(i=>({...i,hasDeletedServerStages:!0})),o&&A(i=>({...i,hasReassignedContentTypes:!0}))):Q()},validate(o){return(0,e.v)({values:o,formatMessage:n})}});return(0,e.u)(W.R,e.i),l.useEffect(()=>(!P&&U&&g&&(_((0,e.l)({workflow:U})),_((0,e.d)({workflows:g}))),I||_((0,e.e)({collectionTypes:p,singleTypes:x})),K||_((0,e.f)(V)),_((0,e.g)(P||I||K)),()=>{_((0,e.r)())}),[p,_,I,P,K,V,x,U,g]),l.useEffect(()=>{!P&&!N&&(O&&v&&O?.workflowCount>parseInt(v,10)?d("workflow"):a.stages&&f&&a.stages.length>parseInt(f,10)&&d("stage"))},[a.stages,N,P,u,O,v,f]),l.useEffect(()=>{!m&&k?.length===0&&D({blockTransition:!0,type:"warning",message:n({id:"Settings.review-workflows.stage.permissions.noPermissions.description",defaultMessage:"You don\u2019t have the permission to see roles"})})},[n,m,k,D]),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(h.D,{}),(0,t.jsx)(R.FormikProvider,{value:y,children:(0,t.jsxs)(R.Form,{onSubmit:y.handleSubmit,children:[(0,t.jsx)(h.H,{navigationAction:(0,t.jsx)(h.B,{href:"/settings/review-workflows"}),primaryAction:B&&(0,t.jsx)(G.$,{startIcon:(0,t.jsx)(b.A,{}),type:"submit",size:"M",disabled:!ds,loading:!Boolean(Object.keys(c).length>0)&&Os,children:n({id:"global.save",defaultMessage:"Save"})}),subtitle:!m&&n({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:a.stages?.length}),title:a.name||""}),(0,t.jsx)(h.R,{children:m?(0,t.jsx)(C.s,{justifyContent:"center",children:(0,t.jsx)(J.a,{children:n({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"})})}):(0,t.jsxs)(C.s,{alignItems:"stretch",direction:"column",gap:7,children:[(0,t.jsx)(e.W,{canUpdate:B}),(0,t.jsx)(e.S,{canDelete:Ms,canUpdate:B,stages:y.values?.stages})]})})]})}),(0,t.jsx)(M.ConfirmDialog.Root,{isConfirmButtonLoading:m,isOpen:Object.keys(c).length>0,onToggleDialog:vs,onConfirm:ms,children:(0,t.jsx)(M.ConfirmDialog.Body,{children:(0,t.jsxs)(C.s,{direction:"column",gap:5,children:[c.hasDeletedServerStages&&(0,t.jsx)(L.o,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.stages.body",defaultMessage:"All entries assigned to deleted stages will be moved to the previous stage."})}),c.hasReassignedContentTypes&&(0,t.jsx)(L.o,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.contentType.body",defaultMessage:"{count} {count, plural, one {content-type} other {content-types}} {count, plural, one {is} other {are}} already mapped to {count, plural, one {another workflow} other {other workflows}}. If you save changes, {count, plural, one {this} other {these}} {count, plural, one {content-type} other {{count} content-types}} will no more be mapped to the {count, plural, one {another workflow} other {other workflows}} and all corresponding information will be removed."},{count:Z?.filter(o=>a.contentTypes?.includes(o)).length})}),(0,t.jsx)(L.o,{textAlign:"center",variant:"omega",children:n({id:"Settings.review-workflows.page.delete.confirm.confirm",defaultMessage:"Are you sure you want to save?"})})]})})}),(0,t.jsxs)(E.L.Root,{isOpen:Y==="workflow",onClose:()=>d(null),children:[(0,t.jsx)(E.L.Title,{children:n({id:"Settings.review-workflows.edit.page.workflows.limit.title",defaultMessage:"You\u2019ve reached the limit of workflows in your plan"})}),(0,t.jsx)(E.L.Body,{children:n({id:"Settings.review-workflows.edit.page.workflows.limit.body",defaultMessage:"Delete a workflow or contact Sales to enable more workflows."})})]}),(0,t.jsxs)(E.L.Root,{isOpen:Y==="stage",onClose:()=>d(null),children:[(0,t.jsx)(E.L.Title,{children:n({id:"Settings.review-workflows.edit.page.stages.limit.title",defaultMessage:"You have reached the limit of stages for this workflow in your plan"})}),(0,t.jsx)(E.L.Body,{children:n({id:"Settings.review-workflows.edit.page.stages.limit.body",defaultMessage:"Try deleting some stages or contact Sales to enable more stages."})})]})]})}}}]);
